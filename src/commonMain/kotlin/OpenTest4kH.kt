/*
 * Copyright 2015-2018 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
@file:Suppress("EXTENSION_SHADOWED_BY_MEMBER")

package com.willowtreeapps.opentest4k

import kotlin.reflect.KClass

/**
 * Serializable representation of a value that was used in an assertion.
 *
 * This class only stores the value if it implements
 * [Serializable][java.io.Serializable] (on js this is always the case).
 *
 * In any case, it stores its runtime type, [identity hash code][identityHashCode]},
 * and [string representation][stringRepresentation]} determined via `toString()`.
 * If the invocation of `toString()` throws an [Exception], the string representation
 * will take the form of `"<Exception in toString(): " + e + ">"`, where "e" is the
 * caught exception.
 *
 * The [toString] method returns the string representation of the
 * value along with its type and identity hash code.
 *
 * @author Marc Philipp
 * @author Sam Brannen
 * @since 1.0
 */
expect class ValueWrapper

/**
 * Wraps a value in a new [ValueWrapper].
 *
 * If the receiver is `null`, this method will return a
 * cached `ValueWrapper` suitable for all null values.
 *
 * @receiver the value to wrap
 * @return a wrapper for the supplied value
 */
expect fun Any?.toValueWrapper(): ValueWrapper

/**
 * Returns the value as passed to the constructor in case it implemented
 * [Serializable][java.io.Serializable] (always true on js); otherwise, `null`.
 */
expect val ValueWrapper.value: Any?

/**
 * Returns the value's string representation, i.e. the result of invoking
 * [toString] at the time this object's constructor was
 * called. Returns `"null"` if the value was `null`.
 */
expect val ValueWrapper.stringRepresentation: String

/**
 * Returns the value's identity hash code, i.e. the result of invoking
 * `System.identityHashCode` ([Any.hashCode] on js) at the time this object's constructor
 * was called. Returns `0` if the value was `null`.
 */
expect val ValueWrapper.identityHashCode: Int

/**
 * `AssertionFailedError` is a common base class for test-related
 * [AssertionErrors][AssertionError].
 *
 * In addition to a message and a cause, this class stores the expected
 * and actual values of an assertion using the [ValueWrapper] type.
 *
 * @author Sam Brannen
 * @author Marc Philipp
 * @since 1.0
 */
expect open class AssertionFailedError : AssertionError {
    /**
     * Constructs an `AssertionFailedError` with an optional message and cause
     * but without expected/actual values.
     */
    constructor(message: String? = null, cause: Throwable? = null)

    /**
     * Constructs an `AssertionFailedError` with a message,
     * expected/actual values, and optional cause.
     */
    constructor(message: String?, expected: Any?, actual: Any?, cause: Throwable? = null)
}

/**
 * Returns `true` if the expected value is defined, i.e. was passed
 * to the constructor.
 *
 * @see [expected]
 */
expect val AssertionFailedError.isExpectedDefined: Boolean

/**
 * Returns `true` if the actual value is defined, i.e. was passed
 * to the constructor.
 *
 * @see [actual]
 */
expect val AssertionFailedError.isActualDefined: Boolean

/**
 * Returns the wrapped expected value if it is defined; otherwise `null`.
 *
 * @see [isExpectedDefined]
 */
expect val AssertionFailedError.expected: ValueWrapper?

/**
 * Returns the wrapped actual value if it is defined; otherwise `null`.
 *
 * @see [isActualDefined]
 */
expect val AssertionFailedError.actual: ValueWrapper?

/**
 * `MultipleFailuresError` is an [AssertionError] which
 * aggregates multiple `AssertionErrors` thrown in a given context
 * (i.e., typically within the invocation of a single test).
 *
 * @author Johannes Link
 * @author Sam Brannen
 * @author Marc Philipp
 * @since 1.0
 */
expect open class MultipleFailuresError(heading: String?, failures: List<Throwable>) : AssertionError {
    fun hasFailures(): Boolean
}

expect val MultipleFailuresError.failures: List<Throwable>

/**
 * [RuntimeException] used to indicate that the execution of a test
 * was incomplete &mdash; for example, that the execution was entirely
 * skipped or aborted mid-stream. See subclasses for concrete use cases.
 *
 * An `IncompleteExecutionException` is **not** used
 * to indicate that a test execution failed.
 *
 * @author Johannes Link
 * @author Sam Brannen
 * @since 1.0
 */
expect open class IncompleteExecutionException(message: String? = null, cause: Throwable? = null) : RuntimeException

/**
 * Specialization of [IncompleteExecutionException] used to indicate
 * that a test was aborted during execution (e.g., due to a failed
 * *assumption*).
 *
 * @author Sam Brannen
 * @author Johannes Link
 * @since 1.0
 * @see TestSkippedException
 */
expect open class TestAbortedException(message: String? = null, cause: Throwable? = null) : IncompleteExecutionException

/**
 * Specialization of [IncompleteExecutionException] used to indicate
 * that a test was skipped *prior* to execution (e.g., *disabled*
 * or *ignored*).
 *
 * @author Sam Brannen
 * @author Johannes Link
 * @since 1.0
 * @see TestAbortedException
 */
expect open class TestSkippedException(message: String? = null, cause: Throwable? = null) : IncompleteExecutionException

internal expect fun Throwable.className(): String
